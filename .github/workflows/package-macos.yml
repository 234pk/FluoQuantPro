name: Build and Package macOS

on:
  push:
    tags:
      - 'v*'
      - 'mac.v*'
  workflow_dispatch:

jobs:
  build-macos:
    name: Build macOS (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-13, macos-latest]
    permissions:
      contents: write
    
    defaults:
      run:
        working-directory: FluoQuantPro

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: 'FluoQuantPro/requirements.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        brew install create-dmg graphicsmagick imagemagick

    - name: Prepare Icon
      run: |
        # Create .icns from .png for the App Bundle
        mkdir -p FluoQuantPro.iconset
        sips -z 16 16     resources/icon.png --out FluoQuantPro.iconset/icon_16x16.png
        sips -z 32 32     resources/icon.png --out FluoQuantPro.iconset/icon_16x16@2x.png
        sips -z 32 32     resources/icon.png --out FluoQuantPro.iconset/icon_32x32.png
        sips -z 64 64     resources/icon.png --out FluoQuantPro.iconset/icon_32x32@2x.png
        sips -z 128 128   resources/icon.png --out FluoQuantPro.iconset/icon_128x128.png
        sips -z 256 256   resources/icon.png --out FluoQuantPro.iconset/icon_128x128@2x.png
        sips -z 256 256   resources/icon.png --out FluoQuantPro.iconset/icon_256x256.png
        sips -z 512 512   resources/icon.png --out FluoQuantPro.iconset/icon_256x256@2x.png
        sips -z 512 512   resources/icon.png --out FluoQuantPro.iconset/icon_512x512.png
        iconutil -c icns FluoQuantPro.iconset
        mv FluoQuantPro.icns resources/icon.icns

    - name: Build macOS App
      run: |
        # Check architecture
        echo "Building for architecture: $(uname -m)"
        pyinstaller FluoQuantPro.spec --noconfirm

    - name: Sign and Verify App
      run: |
        # Ensure executable permission
        chmod +x dist/FluoQuantPro.app/Contents/MacOS/FluoQuantPro
        
        # Ad-hoc code signing for all binaries inside the bundle with entitlements
        if [ -f "entitlements.plist" ]; then
          find dist/FluoQuantPro.app/Contents/MacOS -type f -exec codesign --force --deep --options runtime --entitlements entitlements.plist --sign - {} +
          codesign --force --deep --options runtime --entitlements entitlements.plist --sign - dist/FluoQuantPro.app
        else
          codesign --force --deep --options runtime --sign - dist/FluoQuantPro.app
        fi
        
        # Verify signature
        codesign --verify --verbose dist/FluoQuantPro.app

    - name: Create DMG Installer
      run: |
        # Get architecture
        ARCH=$(uname -m)
        DMG_NAME="FluoQuantPro-macOS-${ARCH}.dmg"
        echo "DMG_NAME=${DMG_NAME}" >> $GITHUB_ENV
        
        # Use create-dmg to make a professional installer
        test -f "dist/${DMG_NAME}" && rm "dist/${DMG_NAME}"
        create-dmg \
          --volname "FluoQuantPro Installer" \
          --volicon "resources/icon.icns" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "FluoQuantPro.app" 200 190 \
          --hide-extension "FluoQuantPro.app" \
          --app-drop-link 600 185 \
          "dist/${DMG_NAME}" \
          "dist/FluoQuantPro.app"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DMG_NAME }}
        path: FluoQuantPro/dist/${{ env.DMG_NAME }}

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: FluoQuantPro/dist/*.dmg
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
